<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Game, Unity, Graphics, Tools, Scripts, C#, Python, Lua, C/C++">
    <meta name="description" content="游戏编程的一些文章">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>游戏编程</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">游戏编程</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">游戏编程</div>
        <div class="logo-desc">
            
            游戏编程的一些文章
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title"></h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-08-10
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="高阶shader">高阶Shader</h1>
<h2 id="unity的渲染管线">Unity的渲染管线</h2>
<p>着色器定义了两点：<strong>1.
对象自身的外观（其材质属性）</strong>；<strong>2.
对象对光照的反应</strong>。由于光照计算必须内置在着色器中，并且有很多可能的光源和阴影类型，因此编写“好用”的高质量着色器将是一项复杂的任务。为了简化这一任务，Unity
提供了表面着色器；在表面着色器中，所有光照、阴影、光照贴图、前向渲染和延迟渲染任务均自动完成。</p>
<h2 id="渲染路径">渲染路径</h2>
<p>如何应用光照以及使用着色器的哪些通道取决于使用的<strong>渲染路径</strong>。着色器中的每个通道均通过<strong>通道标签</strong>来表达其<strong>光照类型</strong>。</p>
<ul>
<li><p>在前向渲染中，将使用 ForwardBase 和 ForwardAdd 通道。</p></li>
<li><p>在延迟着色中，将使用 Deferred 通道。</p></li>
<li><p>在旧版延迟光照中，将使用 PrepassBase 和 PrepassFinal
通道。</p></li>
<li><p>在旧版顶点光照中，将使用 Vertex、VertexLMRGBM 和 VertexLM
通道。</p></li>
<li><p>在上述任何情况中，要渲染阴影或深度纹理，都将使用 ShadowCaster
通道。</p></li>
<li><p>前项渲染 ForwardBase
通道可一次性渲染环境光、光照贴图、主方向光和不重要的（顶点/SH）光源。ForwardAdd
通道用于任何附加的每像素光源；针对此类光源照亮的每个对象进行一次调用。请参阅前向渲染以了解详细信息。</p></li>
</ul>
<p>如果使用前向渲染，<strong>但着色器没有适合前向渲染的通道（即，ForwardBase
和 ForwardAdd
通道类型均不存在），则会按照在顶点光照通道中的方式来渲染该对象</strong></p>
<ul>
<li>延迟着色路径 Deferred
通道将渲染光照<strong>需要的所有信息</strong>（在内置着色器中：漫射颜色、镜面反射颜色、平滑度、
世界空间法线、发光）。它还在发光通道中增加光照贴图、反射探针和环境光照。有关详细信息，请参阅延迟着色。</li>
</ul>
<h2 id="着色器性能">着色器性能</h2>
<ul>
<li>着色器代码需要执行的计算和处理越多，它对游戏性能的影响就越大。</li>
<li>计算的频率也会影响游戏的性能。通常，与顶点数（顶点着色器执行次数）相比，渲染的像素数会更多（因此像素着色器执行次数也更多），而渲染的顶点数比渲染的对象更多。在可能的情况下，可将计算从像素着色器代码移动到顶点着色器代码中，或者将它们完全移出着色器并在脚本中设置值。</li>
</ul>
<h3 id="优化的表面着色器">优化的表面着色器</h3>
<p>表面着色器非常适合编写与光照交互的着色器。但是，它们的默认选项已调整为涵盖大量的一般情况。可针对特定情况调整这些选项以使着色器运行速度更快，或至少让着色器变得更小巧：</p>
<ul>
<li>使用视图方向（即镜面反射）的着色器的 <code>approxview</code>
指令使视图方向按照顶点（而不是按像素）进行标准化。这是近似值，但通常足够好。</li>
<li>适用于镜面反射着色器类型的 <code>halfasview</code>
速度更快。半矢量（光照方向和视图矢量之间）按照顶点进行计算和标准化，并且光照函数接受半矢量作为参数，而不是视图矢量。</li>
<li><code>noforwardadd</code>
使着色器仅完全支持前向渲染中的单方向光。其余的光源仍然可提供每顶点光源或球谐函数光源的效果。这样可以使着色器更小并确保它始终在一个通道中渲染，即使存在多个光源也是如此。</li>
<li><code>noambient</code>
在着色器中禁用环境光照和球谐函数光源。这样可以稍稍提高性能。</li>
</ul>
<h3 id="计算精度">计算精度</h3>
<p>用 Cg/HLSL 编写着色器时，有三种基本数字类型：float、half 和
fixed（请参阅数据类型和精度）。</p>
<p>为获得良好性能，请始终使用尽可能低的精度。这在移动平台（如 iOS 和
Android）上尤为重要。重要的经验法则如下：</p>
<ul>
<li>对于世界空间位置和纹理坐标，请使用 float 精度。</li>
<li>对于所有其他情况（矢量、HDR 颜色等），请首先尝试 half
精度。仅在必要的情况下再提高精度。</li>
<li>要对纹理数据进行非常简单的运算，请使用 fixed 精度。</li>
</ul>
<p>实际上，具体应该使用哪种数字类型取决于平台和 GPU。</p>
<h3 id="alpha-测试">Alpha 测试</h3>
<p>固定函数 AlphaTest（或者其可编程的等效函数
clip()）在不同平台上具有不同的性能特征：</p>
<ul>
<li>通常，在使用该函数来移除大多数平台上的完全透明像素时，可获得少量优势。</li>
<li>但是，在 iOS 和某些 Android 设备的 PowerVR GPU 上，Alpha
测试是资源密集型任务。不要试图在这些平台上使用这种测试进行性能优化，因为它会导致游戏运行速度比平常慢。</li>
</ul>
<h3 id="颜色遮罩-color-mask">颜色遮罩 (Color Mask)</h3>
<p>在某些平台（主要是 iOS 和 Android 设备的移动端 GPU）上，使用
ColorMask 省略一些通道（例如 ColorMask
RGB）<strong>可能是资源密集型的操作，所以除非绝对需要，否则请不要使用</strong>。</p>
<h3 id="使用替换的着色器进行渲染">使用替换的着色器进行渲染</h3>
<p>有些渲染效果需要使用一组不同的着色器来渲染场景。例如，良好的边缘检测要求纹理具有场景法线，这样才能检测出表面方向不同的边缘。其他效果可能要求纹理具有场景深度，诸如此类。为此，可使用所有对象的替换着色器来渲染场景。</p>
<p>应通过脚本使用函数 Camera.RenderWithShader 或
Camera.SetReplacementShader 来实现着色器替换。这两个函数均采用 shader 和
replacementTag。</p>
<p>工作方式如下：摄像机按正常方式渲染场景，对象仍使用自己的材质，但要更改最终使用的实际着色器：</p>
<ul>
<li>如果 replacementTag
为空，则使用指定的替换着色器来渲染场景中的所有对象。</li>
<li>如果 replacementTag 不为空，则对于将要渲染的每个对象：
<ul>
<li>查询真实对象的着色器以获取标签值。</li>
<li>如果没有该标签，则不渲染对象。</li>
<li>在替换着色器中找到一个子着色器，并且该子着色器的一个给定标签具有找到的值。如果找不到此类子着色器，则不渲染对象。</li>
<li>现在，使用该子着色器来渲染对象。</li>
</ul></li>
</ul>
<p>因此，比如说，如果所有着色器都要有一个值为“Opaque”、“Transparent”、“Background”或“Overlay”的“RenderType”标签，则可编写一个替换着色器，该着色器只使用一个具有
RenderType = Solid
标签的子着色器来渲染实体对象。在替换着色器中找不到其他标签类型，因此不会渲染对象。或者您也可以为不同“RenderType”标签值编写若干子着色器。顺便提一下，Unity
的所有内置着色器都设置了一个“RenderType”标签。</p>
<h3 id="光照着色器替换">光照着色器替换</h3>
<p>使用着色器替换时，将使用摄像机上配置的渲染路径来渲染场景。这意味着用于替换的着色器可以包含阴影和光照通道（您可以使用表面着色器进行着色器替换）。这对于渲染特殊效果和场景调试很有用。</p>
<h3 id="unity-内置着色器中的着色器替换标签">Unity
内置着色器中的着色器替换标签</h3>
<p>Unity
的所有内置着色器都设置了一个“RenderType”标签，可以在使用替换着色器进行渲染时使用此标签。标签值如下：</p>
<ul>
<li>Opaque：大部分着色器（法线、自发光、反射和地形着色器）。</li>
<li>Transparent：大部分半透明着色器（透明、粒子、字体和地形附加通道着色器）。</li>
<li>TransparentCutout：遮罩透明度着色器（透明镂空、两个通道植被着色器）。</li>
<li>Background：天空盒着色器。</li>
<li>Overlay：GUI 纹理、光环、光晕着色器。</li>
<li>TreeOpaque：地形引擎树皮。</li>
<li>TreeTransparentCutout：地形引擎树叶。</li>
<li>TreeBillboard：地形引擎公告牌树。</li>
<li>Grass：地形引擎草。</li>
<li>GrassBillboard：地形引擎公告牌草。</li>
</ul>
<h3 id="内置场景深度法线纹理">内置场景深度/法线纹理</h3>
<p>摄像机内置了渲染深度或深度+法线纹理的功能（可能在某些效果中需要该功能）。请参阅摄像机深度纹理页面。请注意，在某些情况下（取决于硬件），可以使用着色器替换方法在内部渲染深度和深度+法线纹理。因此，务必在着色器中设置正确的“RenderType”标签。</p>
<h3 id="自定义着色器-gui">自定义着色器 GUI</h3>
<h3 id="使用深度纹理">使用深度纹理</h3>
<p>深度纹理中的像素值介于 0 和 1 之间，具有非线性分布。精度通常为 32 或
16 位，具体取决于所使用的配置和平台。从深度纹理读取时，将返回 0 到
1范围内的高精度值。如果您需要获取与摄像机之间的距离或其他 0 到 1
之间的线性值，</p>
<pre><code>Shader "Render Depth" {
    SubShader {
        Tags { "RenderType"="Opaque" }
        Pass {
            CGPROGRAM

            #pragma vertex vert
            #pragma fragment frag
            #include "UnityCG.cginc"

            struct v2f {
                float4 pos : SV_POSITION;
                float2 depth : TEXCOORD0;
            };

            v2f vert (appdata_base v) {
                v2f o;
                o.pos = UnityObjectToClipPos(v.vertex);
                UNITY_TRANSFER_DEPTH(o.depth);
                return o;
            }

            half4 frag(v2f i) : SV_Target {
                UNITY_OUTPUT_DEPTH(i.depth);
            }
            ENDCG
        }
    }
}</code></pre>
<h3 id="摄像机的深度纹理">摄像机的深度纹理</h3>
<p><strong>TODO</strong></p>
<h3 id="平台特定的渲染差异">平台特定的渲染差异</h3>
<h4 id="渲染纹理坐标">渲染纹理坐标</h4>
<ul>
<li>Direct3D 类：顶部坐标为 0 并向下增加。此类型适用于 Direct3D、Metal
和游戏主机。</li>
<li>OpenGL 类：底部坐标为 0 并向上增加。此类适用于 OpenGL 和 OpenGL
ES。</li>
</ul>
<h4 id="图像效果">图像效果</h4>
<pre><code>// 翻转纹理的采样：
// 主纹理的
// 纹理像素大小将具有负 Y。

# if UNITY_UV_STARTS_AT_TOP
if (_MainTex_TexelSize.y &lt; 0)
        uv.y = 1-uv.y;
# endif</code></pre>
<h4 id="在-uv-空间中渲染">在 UV 空间中渲染</h4>
<p>在纹理坐标 (UV)
空间中渲染特殊效果或工具时，您可能需要调整着色器，以便在 Direct3D 类和
OpenGL
类系统之间进行一致渲染。您还可能需要在渲染到屏幕和渲染到纹理之间进行渲染调整。为进行此类调整，应上下翻转
Direct3D 类投影，使其坐标与 OpenGL 类投影坐标相匹配。</p>
<p>内置变量 ProjectionParams.x 包含值 +1 或 –1。-1
表示投影已上下翻转以匹配 OpenGL 类投影坐标，而 +1 表示尚未翻转。
您可以在着色器中检查此值，然后执行不同的操作。下面的示例将检查是否已翻转投影，如果已翻转，则再次进行翻转，然后返回
UV 坐标以便匹配。</p>
<pre><code>float4 vert(float2 uv : TEXCOORD0) : SV_POSITION
{
    float4 pos;
    pos.xy = uv;
    // 此示例使用上下翻转的投影进行渲染，
    // 因此也翻转垂直 UV 坐标
    if (_ProjectionParams.x &lt; 0)
        pos.y = 1 - pos.y;
    pos.z = 0;
    pos.w = 1;
    return pos;
}</code></pre>
<h4 id="裁剪空间坐标">裁剪空间坐标</h4>
<p>与纹理坐标类似，裁剪空间坐标（也称为投影后空间坐标）在 Direct3D 类和
OpenGL 类平台之间有所不同：</p>
<ul>
<li><p>Direct3D 类：裁剪空间深度从近平面的 0.0 到远平面的
+1.0。此类型适用于 Direct3D、Metal 和游戏主机。</p></li>
<li><p>OpenGL 类：裁剪空间深度从近平面的 –1.0 到远平面的
+1.0。此类适用于 OpenGL 和 OpenGL ES。</p></li>
</ul>
<p>在着色器代码内，可使用内置宏 UNITY_NEAR_CLIP_VALUE
来获取基于平台的近平面值。</p>
<h4 id="着色器计算的精度">着色器计算的精度</h4>
<p>要避免精度问题，<strong>请确保在目标平台上测试着色器</strong>。移动设备和
PC 中的 GPU 在处理浮点类型方面有所不同。</p>
<h4 id="着色器中的-const-声明">着色器中的 const 声明</h4>
<p>const 的使用在 Microsoft HSL（请参阅 msdn.microsoft.com）和 OpenGL 的
GLSL（请参阅 Wikipedia）着色器语言之间有所不同。</p>
<ul>
<li><p>Microsoft 的 HLSL const 与 C# 和 C++
中的含义大致相同：声明的变量在其作用域内是只读的，但可按任何方式初始化。</p></li>
<li><p>OpenGL 的 GLSL const
表示变量实际上是<strong>编译时常量</strong>，因此必须使用编译时约束（文字值或其他对于
const 的计算）进行初始化。</p></li>
</ul>
<p>最好是遵循 OpenGL 的 GLSL
语义，并且只有当变量真正不变时才将变量声明为
const。避免使用其他一些可变值初始化 const
变量（例如，作为函数中的局部变量）。这一原则也适用于 Microsoft 的
HLSL，因此以这种方式使用 const 可以避免在某些平台上混淆错误</p>
<h3 id="提取深度缓冲区">提取深度缓冲区</h3>
<p>如果要手动提取深度 (Z)
缓冲区值，则可能需要检查缓冲区方向。以下是执行此操作的示例：</p>
<pre><code>float z = tex2D(_CameraDepthTexture, uv);
# if defined(UNITY_REVERSED_Z)
    z = 1.0f - z;
# endif</code></pre>
<h3 id="使用裁剪空间">使用裁剪空间</h3>
<p>如果要手动使用裁剪空间 (Z)
深度，则可能还需要使用以下宏来抽象化平台差异：</p>
<pre><code>float clipSpaceRange01 = UNITY_Z_0_FAR_FROM_CLIPSPACE(rawClipSpace);</code></pre>
<p>注意：此宏不会改变 OpenGL 或 OpenGL ES
平台上的裁剪空间，因此在这些平台上，此宏返回“-near”1（近平面）到
far（远平面）之间的值。</p>
<h3 id="投影矩阵">投影矩阵</h3>
<p>如果处于深度 (Z) 发生反转的平台上，则 GL.GetGPUProjectionMatrix()
返回一个还原了 z 的矩阵。
但是，如果要手动从投影矩阵中进行合成（例如，对于自定义阴影或深度渲染），您需要通过脚本按需自行还原深度
(Z) 方向。</p>
<p>以下是执行此操作的示例：</p>
<pre><code>var shadowProjection = Matrix4x4.Ortho(...); //阴影摄像机投影矩阵
var shadowViewMat = ...     //阴影摄像机视图矩阵
var shadowSpaceMatrix = ... //从裁剪空间到阴影贴图纹理空间
    
//当引擎通过摄像机投影计算设备投影矩阵时，
//"m_shadowCamera.projectionMatrix"被隐式反转
m_shadowCamera.projectionMatrix = shadowProjection; 

//"shadowProjection"在连接到"m_shadowMatrix"之前被手动翻转，
//因为它被视为着色器的其他矩阵。
if(SystemInfo.usesReversedZBuffer) 
{
    shadowProjection[2, 0] = -shadowProjection[2, 0];
    shadowProjection[2, 1] = -shadowProjection[2, 1];
    shadowProjection[2, 2] = -shadowProjection[2, 2];
    shadowProjection[2, 3] = -shadowProjection[2, 3];
}
m_shadowMatrix = shadowSpaceMatrix * shadowProjection * shadowViewMat;</code></pre>
<h3 id="深度-z-偏差">深度 (Z) 偏差</h3>
<p>Unity 自动处理深度 (Z) 偏差，以确保其与 Unity 的深度 (Z)
方向匹配。但是，如果要使用本机代码渲染插件，则需要在 C 或 C++
代码中消除（反转）深度 (Z) 偏差。</p>
<h3 id="深度-z-方向检查工具">深度 (Z) 方向检查工具</h3>
<ul>
<li>使用 SystemInfo.usesReversedZBuffer 可确认所在平台是否使用反转深度
(Z)。</li>
</ul>
<h2 id="着色器细节级别">着色器细节级别</h2>
<p>仅当使用的着色器或子着色器的细节级别 (LOD) 值低于指定数字时，着色器
LOD 才有效。</p>
<p>默认情况下，允许的 LOD
级别无限大，因此可以使用用户硬件支持的所有着色器。但在某些情况下，即使硬件可以支持更高的着色器细节级别，您也可能希望降低细节级别。例如，一些廉价的显卡可能支持所有功能，但使用起来会导致响应过慢。因此，您可能不希望在这些显卡上使用视差法线贴图。</p>
<p>可为各个着色器分别设置着色器 LOD（使用
Shader.maximumLOD），也可为所有着色器进行全局设置（使用
Shader.globalMaximumLOD）。</p>
<p>Unity 中的内置着色器按以下方式设置 LOD：</p>
<ul>
<li>顶点光照 (VertexLit) 类型着色器 = 100</li>
<li>贴花、反光顶点光照 = 150</li>
<li>漫射 = 200</li>
<li>漫射细节、反光凹凸无光照、反光凹凸顶点光照 = 250</li>
<li>凹凸、镜面反射 = 300</li>
<li>凹凸镜面反射 = 400</li>
<li>视差 = 500</li>
<li>视差镜面反射 = 600</li>
</ul>
<h2 id="纹理数组">纹理数组</h2>
<p>类似于常规 2D 纹理（Texture2D 类，着色器中的
sampler2D__）、立方体贴图（Cubemap 类，着色器中的 samplerCUBE__）和 3D
纹理（Texture3D 类，着色器中的 <strong>sampler3D</strong>），Unity
也支持 2D 纹理数组。</p>
<p>纹理数组是具有相同大小/格式/标记的 2D
纹理的<strong>集合</strong>，这些纹理对于 GPU
而言像是单个对象，并可在着色器中使用纹理元素索引进行采样。它们可以用于实现自定义地形渲染系统或其他特殊效果，让您高效访问大量相同大小和格式的纹理。2D
纹理数组的元素也称为<strong>切片或图层</strong>。</p>
<h3 id="平台支持">平台支持</h3>
<p>纹理数组需要受到底层图形 API 和 GPU
的支持。纹理数组在以下平台上可用：</p>
<ul>
<li>Direct3D 11/12（Windows、Xbox One）</li>
<li>OpenGL Core（Mac OS X、Linux）</li>
<li>Metal（iOS、Mac OS X）</li>
<li>OpenGL ES 3.0（Android、iOS、WebGL 2.0）</li>
<li>PlayStation 4</li>
</ul>
<p>其他平台（OpenGL ES 2.0 或 WebGL 1.0）不支持纹理数组。可使用
<code>SystemInfo.supports2DArrayTextures</code>
在运行时确定纹理数组支持情况。</p>
<h3 id="创建和填充纹理数组">创建和填充纹理数组</h3>
<p>由于纹理数组没有纹理导入管线，必须在脚本中创建纹理数组。可使用
Texture2DArray
类来创建和填充纹理数组。请注意，纹理数组可序列化为资源，因此可以借助
Editor 脚本中的数据创建和填充纹理数组。</p>
<p>通常，纹理数组完全是在 GPU 内存中使用，但您可以使用
Graphics.CopyTexture、Texture2DArray.GetPixels 和
Texture2DArray.SetPixels 与系统内存之间双向传输像素。</p>
<h3 id="将纹理数组用作渲染目标">将纹理数组用作渲染目标</h3>
<p>纹理数组元素也可用作渲染目标。使用 RenderTexture.dimension
提前指定渲染目标是否是 2D 纹理数组。Graphics.SetRenderTarget 的
depthSlice 参数可指定要渲染到的 Mipmap
级别或立方体贴图面。在支持“分层渲染”（例如，几何着色器）的平台上，可将
depthSlice 参数设置为 –1
以便将整个纹理数组设置为渲染目标。此外还可使用几何着色器来渲染到个别元素中。</p>
<h3 id="在着色器中使用纹理数组">在着色器中使用纹理数组</h3>
<p>由于纹理数组并非适用于所有平台，因此着色器需要使用适当的编译目标或功能要求来访问纹理数组。支持纹理数组的最低着色器模型<strong>编译目标为
3.5，功能名称为 2darray</strong>。</p>
<p>使用以下宏可声明和采样纹理数组：</p>
<ul>
<li>UNITY_DECLARE_TEX2DARRAY(name) 在 HLSL
代码中声明纹理数组采样器变量。</li>
<li>UNITY_SAMPLE_TEX2DARRAY(name,uv) 使用 float3 UV 采样纹理数组；坐标的
z 分量是数组元素索引。</li>
<li>UNITY_SAMPLE_TEX2DARRAY_LOD(name,uv,lod) 使用显式 Mipmap
级别采样纹理数组。</li>
</ul>
<pre><code>Shader "Example/Sample2DArrayTexture"
{
    Properties
    {
        _MyArr ("Tex", 2DArray) = "" {}
        _SliceRange ("Slices", Range(0,16)) = 6
        _UVScale ("UVScale", Float) = 1.0
    }
    SubShader
    {
        Pass
        {
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            // 纹理数组并非在任何地方都可用，
            // 只能在它们所在的平台上编译着色器
            #pragma require 2darray
            
            #include "UnityCG.cginc"

            struct v2f
            {
                float3 uv : TEXCOORD0;
                float4 vertex : SV_POSITION;
            };

            float _SliceRange;
            float _UVScale;

            v2f vert (float4 vertex : POSITION)
            {
                v2f o;
                o.vertex = mul(UNITY_MATRIX_MVP, vertex);
                o.uv.xy = (vertex.xy + 0.5) * _UVScale;
                o.uv.z = (vertex.z + 0.5) * _SliceRange;
                return o;
            }
            
            UNITY_DECLARE_TEX2DARRAY(_MyArr);

            half4 frag (v2f i) : SV_Target
            {
                return UNITY_SAMPLE_TEX2DARRAY(_MyArr, i.uv);
            }
            ENDCG
        }
    }
}</code></pre>
<h2 id="使用-visual-studio-来调试-directx-1112-着色器">使用 Visual
Studio 来调试 DirectX 11/12 着色器</h2>
<h2 id="使用-pix-来调试-directx-12-着色器">使用 PIX 来调试 DirectX 12
着色器</h2>
<h2 id="在着色器中实现固定函数-texgen">在着色器中实现固定函数
TexGen</h2>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Yonggang Long</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://one2world.github.io/2022/08/10/unity/shader/8.gao-jie-shader-zhu-ti/">https://one2world.github.io/2022/08/10/unity/shader/8.gao-jie-shader-zhu-ti/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Yonggang Long</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/null" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/null" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    
        <div class="disqus-card card" data-aos="fade-up">
    <div id="disqus_thread" class="card-content">
        <noscript>Please enable JavaScript to view the
            <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
    </div>
</div>

<script type="text/javascript">
    disqus_config = function () {
        this.page.url = 'https://one2world.github.io/2022/08/10/unity/shader/8.gao-jie-shader-zhu-ti/';
        this.page.identifier = '/2022/08/10/unity/shader/8.gao-jie-shader-zhu-ti/';
        this.page.title = '';
    };
    let disqus_shortname = '';

    (function () { // DON'T EDIT BELOW THIS LINE
        let d = document, s = d.createElement('script');
        // 如：s.src = 'https://blinkfox.disqus.com/embed.js';
        s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/08/10/unity/shader/9.you-hua-tu-xing-xing-neng/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="">
                        
                        <span class="card-title"></span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-08-10
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Yonggang Long
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/08/10/unity/shader/7.shaderlab-yu-fa/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="">
                        
                        <span class="card-title"></span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-08-10
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Yonggang Long
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">Yonggang Long</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/one2world" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:longyonggang2@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=873415756" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 873415756" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>





    <a href="https://www.zhihu.com/people/cheng-xu-jie-kang-ba-zi" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/cheng-xu-jie-kang-ba-zi" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
